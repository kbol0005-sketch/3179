{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "params": [
    {
      "name": "Min_Passenger_Traffic",
      "value": 0,
      "bind": {
        "input": "range",
        "min": 0,
        "max": 8000000,
        "step": 200000,
        "name": "Minimum Passenger Traffic: "
      }
    },
    {
      "name": "Change_Filter",
      "value": "All",
      "bind": {
        "input": "select",
        "options": [
          "All",
          "Decrease > 15%",
          "Decrease > 5%",
          "Increase > 5%",
          "Increase > 15%"
        ],
        "name": "Traffic Change vs 2019: "
      }
    }
  ],
  "vconcat": [
    {
      "width": 800,
      "height": 600,
      "projection": {"type": "mercator"},
      "layer": [
      {
        "params": [
          {
            "name": "routeSelect",
            "select": {
              "type": "point", 
              "fields": ["city_pair"], 
              "on": "click"
            }
          }
        ],
        "data": {
          "url": "./js/australia_states.topojson",
          "format": {
            "type": "topojson",
            "feature": "ne_50m_admin_1_states_provinces"
          }
        },
        "mark": {
          "type": "geoshape",
          "fill": "#f7f3e9",
          "stroke": "#333333",
          "strokeOpacity": 1,
          "strokeWidth": 0.3
        }
      },
      {
        "data": {
          "url": "./js/australia_states.topojson",
          "format": {
            "type": "topojson",
            "feature": "ne_50m_admin_1_states_provinces"
          }
        },
        "transform": [
          {
            "calculate": "datum.properties.name === 'Australian Capital Territory' ? 'ACT' : datum.properties.name",
            "as": "state_label"
          }
        ],
        "mark": {"type": "text", "fontSize": 10, "color": "#a6a6a6"},
        "encoding": {
          "longitude": {"field": "properties.longitude"},
          "latitude": {"field": "properties.latitude"},
          "text": {"field": "state_label"}
        }
      },
      {
        "data": {
          "url": "./js/australia_routes_lines.geojson",
          "format": {"type": "json", "property": "features"}
        },
        "transform": [
          {"filter": "datum.properties.passengers > Min_Passenger_Traffic"},
          {
            "filter": "Change_Filter == 'All' || (Change_Filter == 'Decrease > 15%' && datum.properties.change <= -0.15) || (Change_Filter == 'Decrease > 5%' && datum.properties.change <= -0.05) || (Change_Filter == 'Increase > 5%' && datum.properties.change >= 0.05) || (Change_Filter == 'Increase > 15%' && datum.properties.change >= 0.15)"
          },
          {"calculate": "datum.properties.city_pair", "as": "city_pair"}
        ],
        "mark": {
          "type": "geoshape",
          "strokeOpacity": 0.3,
          "stroke": "black",
          "strokeWidth": 0.3
        },
        "encoding": {
          "color": {
            "condition": {
              "param": "routeSelect",
              "empty": false, 
              "value": "#007acc"
            },
            "field": "properties.change",
            "type": "quantitative",
            "scale": {
              "type": "threshold",
              "domain": [-0.15, -0.05, 0.05, 0.15],
              "range": ["#d24c4c", "#ef8a62", "#74add1", "#7fc462", "#178948"]
            },
            "title": "Change vs 2019",
            "legend": null
          },
          "opacity": {
            "condition": {"param": "routeSelect", "value": 1},
            "value": 0.4
          },
          "strokeWidth": {
            "condition": {
              "param": "routeSelect",
              "empty": false,
              "value": 0.3               
            },
            "value": 0.3                 
          },
          "tooltip": [
            {"field": "city_pair", "title": "Route"},
            {"field": "properties.distance_km", "title": "Distance (km)", "format": ".0f"},
            {"field": "properties.passengers", "title": "Passengers", "format": ","},
            {"field": "properties.flights", "title": "Flights", "format": ","},
            {"field": "properties.lf", "title": "Load Factor", "format": ".0%"},
            {"field": "properties.change", "title": "Traffic Change", "format": ".0%"}
          ]
        }
      },
      {
        "data": {
          "url": "./js/australia_airports.topojson",
          "format": {"type": "topojson", "feature": "ne_10m_airports"}
        },
        "mark": {
          "type": "circle",
          "color": "#1f78b4",
          "stroke": "#333333",
          "strokeWidth": 0.3,
          "size": 60
        },
        "encoding": {
          "longitude": {"field": "properties.LON"},
          "latitude": {"field": "properties.LAT"},
          "tooltip": [
            {"field": "properties.name", "title": "Airport"},
            {"field": "properties.iata_code", "title": "IATA"}
          ]
        }
      },
      {
        "data": {
          "url": "./js/australia_airports.topojson",
          "format": {"type": "topojson", "feature": "ne_10m_airports"}
        },
        "transform": [
          {
            "lookup": "properties.iata_code",
            "from": {
              "data": {
                "values": [
                  {"iata": "SYD", "city": "Sydney", "dx": 9, "dy": -1},
                  {"iata": "MEL", "city": "Melbourne", "dx": -10, "dy": -3},
                  {"iata": "BNE", "city": "Brisbane", "dx": 11, "dy": 1},
                  {"iata": "OOL", "city": "Gold Coast", "dx": 12, "dy": -1},
                  {"iata": "ADL", "city": "Adelaide", "dx": -9, "dy": -3},
                  {"iata": "PER", "city": "Perth", "dx": -8, "dy": 0},
                  {"iata": "HBA", "city": "Hobart", "dx": 9, "dy": -1},
                  {"iata": "CBR", "city": "Canberra", "dx": 0, "dy": -4},
                  {"iata": "CNS", "city": "Cairns", "dx": 9, "dy": 0},
                  {"iata": "DRW", "city": "Darwin", "dx": -9, "dy": 0}
                ]
              },
              "key": "iata",
              "fields": ["city", "dx", "dy"]
            }
          },
          {"calculate": "datum.properties.LON + datum.dx*0.2", "as": "LON_shift"},
          {"calculate": "datum.properties.LAT + datum.dy*0.2", "as": "LAT_shift"}
        ],
        "mark": {"type": "text", "fontSize": 12, "color": "#555555", "fontWeight": "bold"},
        "encoding": {
          "longitude": {"field": "LON_shift"},
          "latitude": {"field": "LAT_shift"},
          "text": {"field": "city"}
        }
      },
      {
        "projection": null,
        "layer": [
          {
            "data": {"values": [{"label": "Passenger Traffic"}]},
            "mark": {
              "type": "text",
              "x": 80,
              "y": 477,
              "align": "left",
              "fontSize": 12,
              "fontWeight": "bold",
              "color": "#555555"
            },
            "encoding": {"text": {"field": "label"}}
          },
          {
            "data": {
              "values": [
                {"x": 8, "label": "0.5M"},
                {"x": 23, "label": "1M"},
                {"x": 39, "label": "2M"},
                {"x": 55, "label": "3M"},
                {"x": 71, "label": "5M"},
                {"x": 87, "label": "10M"}
              ]
            },
            "mark": {"type": "text", "baseline": "top", "dy": 5, "fontSize": 11, "color": "#444444"},
            "encoding": {
              "x": {
                "field": "x",
                "type": "quantitative",
                "scale": {"domain": [0, 150], "range": [80, 380]},
                "axis": null
              },
              "y": {"value": 503},
              "text": {"field": "label"},
              "align": {"value": "center"}
            }
          },
          {
            "data": {"values": [{"label": "Traffic Change vs 2019"}]},
            "mark": {
              "type": "text",
              "x": 80,
              "y": 544,
              "align": "left",
              "fontSize": 12,
              "fontWeight": "bold",
              "color": "#555555"
            },
            "encoding": {"text": {"field": "label"}}
          },
          {
            "data": {
              "values": [
                {"x1": 0, "x2": 19, "color": "#d24c4c"},
                {"x1": 19, "x2": 38, "color": "#ef8a62"},
                {"x1": 38, "x2": 57, "color": "#74add1"},
                {"x1": 57, "x2": 76, "color": "#7fc462"},
                {"x1": 76, "x2": 95, "color": "#178948"}
              ]
            },
            "mark": {"type": "rect", "height": 10},
            "encoding": {
              "x": {
                "field": "x1",
                "type": "quantitative",
                "scale": {"domain": [0, 150], "range": [80, 380]},
                "axis": null
              },
              "x2": {
                "field": "x2",
                "type": "quantitative",
                "scale": {"domain": [0, 150], "range": [80, 380]}
              },
              "y": {"value": 562},
              "color": {
                "field": "color",
                "type": "nominal",
                "legend": null,
                "scale": {
                  "domain": ["#d24c4c", "#ef8a62", "#74add1", "#7fc462", "#178948"],
                  "range": ["#d24c4c", "#ef8a62", "#74add1", "#7fc462", "#178948"]
                }
              }
            }
          },
          {
            "data": {
              "values": [
                {"x": 19, "label": "-15%"},
                {"x": 38, "label": "-5%"},
                {"x": 57, "label": "5%"},
                {"x": 76, "label": "15%"}
              ]
            },
            "mark": {"type": "text", "baseline": "top", "dy": 5, "fontSize": 11, "color": "#444444"},
            "encoding": {
              "x": {
                "field": "x",
                "type": "quantitative",
                "scale": {"domain": [0, 150], "range": [80, 380]},
                "axis": null
              },
              "y": {"value": 569},
              "text": {"field": "label"},
              "align": {"value": "center"}
            }
          },
          {
            "data": {
              "values": [
                {"x1": 0, "x2": 15, "y_bottom": 104, "y_top": 106},
                {"x1": 16, "x2": 31, "y_bottom": 103.5, "y_top": 106.5},
                {"x1": 32, "x2": 47, "y_bottom": 103, "y_top": 107},
                {"x1": 48, "x2": 63, "y_bottom": 102.5, "y_top": 107.5},
                {"x1": 64, "x2": 79, "y_bottom": 101, "y_top": 109},
                {"x1": 80, "x2": 95, "y_bottom": 99.5, "y_top": 110.5}
              ]
            },
            "mark": {"type": "rect", "fill": "#888"},
            "encoding": {
              "x": {"field": "x1", "type": "quantitative", "axis": null},
              "x2": {"field": "x2"},
              "y": {
                "field": "y_bottom",
                "type": "quantitative",
                "scale": {"domain": [0, 600], "range": [600, 0]},
                "axis": null
              },
              "y2": {"field": "y_top", "type": "quantitative"}
            }
          }
        ]
      }
    ]
    },


 {
      "hconcat": [
        {
          "width": 60,
          "mark": {"type": "rect", "opacity": 0},   
          "data": {"values": [{}]}
        }, 
        {
          "title": {
          "text": "Passenger Trends by Year",
          "color": "#333333",          
          "font": "Arial",
          "fontSize": 13,
          "fontWeight": "bold",
          "anchor": "middle"
        },
          "width": 550,
          "height": 140,
          "data": {"url": "./data/routes_history.csv"},
          "transform": [
            {
              "fold": [
                "2024","2023","2022","2021","2020",
                "2019","2018","2017","2016","2015"
              ],
              "as": ["year", "passengers"]
            },
            {"calculate": "replace(datum.passengers, ',', '')", "as": "passengers_clean"},
            {"calculate": "toNumber(datum.passengers_clean)", "as": "passengers_num"},
            {"calculate": "datum.passengers_num / 1000", "as": "passengers_thousands"},
            {"filter": {"param": "routeSelect"}},
            {
              "aggregate": [
                {"op": "sum", "field": "passengers_thousands", "as": "total_passengers"},
                {"op": "sum", "field": "passengers_num", "as": "total_passengers_raw"} 
              ],
              "groupby": ["year"]
            }
          ],
          "mark": {"type": "bar", "cornerRadiusEnd": 2, "width":40},
          "encoding": {
            "x": {
              "field": "year",
              "type": "ordinal",
              "sort": "descending",
              "axis": {
                "title": null,
                "labelAngle": 0,
                "labelFontSize": 11,
                "labelColor": "#333333",
                "labelPadding": 6,
                "grid": false,
                "domain": true,
                "domainColor": "#555",
                "domainWidth": 1,
                "ticks": false
              }
            },
            "y": {
              "field": "total_passengers",
              "type": "quantitative",
              "axis": {
                "title": "Passengers (thousands)",
                "titleColor": "#555555",
                "titlePadding": 5,
                "titleFontSize": 12,
                "labelFontSize": 10,
                "labelColor": "#333333",
                "labelPadding": 6,
                "grid": true,
                "gridColor": "#efefef",
                "domain": false,
                "format": ",.0f",
                "ticks": false
              },
              "scale": {"nice": true}
            },
            "color": {
              "condition": [
                {
                  "test": "datum.year == '2024' || datum.year == '2019'",
                  "value": "#f0a800"
                }
              ],
              "value": "#1f77b4"
            },
            "tooltip": [
              {"field": "year", "title": "Year"},
              {"field": "total_passengers_raw", "title": "Passengers", "format": ",.0f"}
            ]
          }
        }
      ]
    }

  ],
  
  "config": {"view": {"stroke": null}, "background": "white"}
}

